<script>
    const GAS_URL =
        'https://script.google.com/macros/s/AKfycbzIex3Sdy37cyePa8FWlxWNQVVgC2dRvgD6up8qADnbh-VB5r4WK60xZWxTmuQCPZ0B/exec';
    let clickStacks = {};
    let pendingRequests = {};

    window.handleHeartClick = function (btn, id) {
        const countSpan = btn.querySelector('.heart-count');
        if (!countSpan) return;

        let currentCount = parseInt(countSpan.innerText) || 0;
        countSpan.innerText = currentCount + 1;

        clickStacks[id] = (clickStacks[id] || 0) + 1;

        btn.style.transform = "scale(1.5)";
        setTimeout(() => {
            btn.style.transform = "scale(1)";
        }, 100);

        if (pendingRequests[id]) clearTimeout(pendingRequests[id]);

        pendingRequests[id] = setTimeout(() => {
            const addedCount = clickStacks[id];
            clickStacks[id] = 0;

            fetch(`${GAS_URL}?action=add&id=${id}&inc=${addedCount}`, {
                    method: 'GET',
                    redirect: 'follow'
                })
                .then(res => res.text())
                .then(newCount => {
                    if (newCount) countSpan.innerText = newCount;
                });
        }, 800);
    };

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.heart-count').forEach(targetSpan => {
            const projectId = targetSpan.id.replace('count-', '');
            targetSpan.innerHTML = '<span class="loading-spinner"></span>';

            fetch(`${GAS_URL}?action=get&id=${projectId}`, {
                    method: 'GET',
                    redirect: 'follow'
                })
                .then(res => res.text())
                .then(count => {
                    targetSpan.innerText = count || 0;
                })
                .catch(() => {
                    targetSpan.innerText = 0;
                });
        });

        const searchInput = document.getElementById('projectSearchInput');
        const cards = document.querySelectorAll('.project-card');
        if (searchInput) {
            searchInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase().replace(/\s+/g, '');
                cards.forEach(card => {
                    const title = card.getAttribute('data-search-title') || "";
                    card.style.display = title.includes(searchTerm) ? 'flex' : 'none';
                });
            });
        }
    });
</script>